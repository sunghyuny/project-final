<!DOCTYPE html>
{% include 'Navbar.html'%}
<html>
<head>
    <title>Chat Room</title>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const roomId = "{{ chat_room.id }}";
            const userId = "{{ request.user.username }}";
            const chatSocket = new WebSocket(
                'ws://' + window.location.hostname + ':8001/ws/chat/' + roomId + '/'
            );

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                const messageList = document.getElementById('chat-log');
                const newMessage = document.createElement('div');

                if (data.sender === userId) {
                    newMessage.classList.add('my-message');
                    newMessage.innerHTML = `[${data.timestamp}]: ${data.message}`;
                } else {
                    newMessage.classList.add('other-message');
                    newMessage.innerHTML = `<strong>${data.sender}</strong> [${data.timestamp}]: ${data.message}`;
                }

                messageList.appendChild(newMessage);
                messageList.scrollTop = messageList.scrollHeight;
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };

            document.querySelector('#chat-message-input').focus();
            document.querySelector('#chat-message-input').onkeyup = function(e) {
                if (e.keyCode === 13) {  // Enter key
                    document.querySelector('#chat-message-submit').click();
                }
            };

            document.querySelector('#chat-message-submit').onclick = function(e) {
                const messageInputDom = document.querySelector('#chat-message-input');
                const message = messageInputDom.value;
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'sender': userId,
                    'timestamp': new Date().toLocaleString()
                }));
                messageInputDom.value = '';
            };
        });
    </script>

    <style>
        .chat_page{

            width:1000px;
            margin: 10px auto;
        }

        #chat-log{
            border: 1px solid;
            height: 500px;
            width: 800px;
            margin: 0 auto;
            overflow-y: scroll;
        }

        .send_message{
            display: flex;
            justify-content: center;
            margin-top:10px;
        }

        #chat-message-input{
            width: 700px;
            padding: 10px;
            font-size: 16px;
        }

        #chat-message-submit{
            background-color: #2295ff;
            border: none;
            color: white;
            font-size: 20px;
            padding: 10px;
        }

        .my-message {
            text-align: right;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .other-message {
            text-align: left;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
<div class="chat_page">
    <h1>{{ chat_room.name }}</h1>
    <div id="chat-log">
        {% for message in messages %}
            {% if message.sender.username == request.user.username %}
                <div class="my-message">
                    {{ message.timestamp|date:"H:i" }} {{ message.content }}
                </div>
            {% else %}
                <div class="other-message">
                    <strong>{{ message.sender.username }}<br></strong> {{ message.content }} {{ message.timestamp|date:"H:i" }}
                </div>
            {% endif %}
        {% endfor %}
    </div>
    <div class="send_message">
        <input type="text" id="chat-message-input">
        <button id="chat-message-submit">전송</button>
    </div>
</div>


</body>
</html>

<!DOCTYPE html>
{% include 'Navbar.html'%}
<html>
<head>
    <title>Chat Room</title>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const roomId = "{{ chat_room.id }}";
            const userId = "{{ request.user.username }}";
            const chatSocket = new WebSocket(
                'ws://' + window.location.hostname + ':8001/ws/chat/' + roomId + '/'
            );

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                const messageList = document.getElementById('chat-log');
                const newMessage = document.createElement('div');
                const messageContent = document.createElement('p');

                if (data.sender === userId) {
                    newMessage.classList.add('my-message');
                    messageContent.classList.add('my_message');
                    messageContent.textContent = data.message;
                    newMessage.innerHTML = `[${data.timestamp}] `;
                    newMessage.appendChild(messageContent);
                } else {
                    newMessage.classList.add('other-message');
                    messageContent.classList.add('other_message');
                    messageContent.textContent = data.message;
                    newMessage.innerHTML = `<strong>${data.sender}</strong> [${data.timestamp}] `;
                    newMessage.appendChild(messageContent);
                }

                messageList.appendChild(newMessage);
                messageList.scrollTop = messageList.scrollHeight;
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };

            document.querySelector('#chat-message-input').focus();
            document.querySelector('#chat-message-input').onkeyup = function(e) {
                if (e.keyCode === 13) {  // Enter key
                    document.querySelector('#chat-message-submit').click();
                }
            };

            document.querySelector('#chat-message-submit').onclick = function(e) {
                const messageInputDom = document.querySelector('#chat-message-input');
                const message = messageInputDom.value;
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'sender': userId,
                    'timestamp': new Date().toLocaleString()
                }));
                messageInputDom.value = '';
            };
        });
    </script>

    <style>
        .chat_page{
            width:1000px;
            margin: 10px auto;
        }

        #chat-log{
            border: 1px solid;
            height: 500px;
            width: 800px;
            margin: 0 auto;
            overflow-y: scroll;
<<<<<<< HEAD
            background-color: #F0F0F0;
=======
>>>>>>> origin/main
        }

        .send_message{
            display: flex;
            justify-content: center;
            margin-top:10px;
        }

        #chat-message-input{
            width: 700px;
            padding: 10px;
            font-size: 16px;
        }

        #chat-message-submit{
            background-color: #2295ff;
            border: none;
            color: white;
            font-size: 20px;
            padding: 10px;
        }

        .my_message, .other_message {
            border: 1px solid;
            display: inline-block;
            padding: 5px;
            text-align: left;
            border-radius: 10px;
        }

        .my_message{
            background-color: #2295ff;
            color: white;
        }

        .other_message{
            background-color: white;
        }
    </style>
</head>
<body>
<div class="chat_page">
    <h1>{{ chat_room.name }}</h1>
    <div id="chat-log">
        {% for message in messages %}
            {% if message.sender.username == request.user.username %}
                <div class="my-message">
                    {{ message.timestamp|date:"H:i" }} <p class="my_message">{{ message.content }}</P>
                </div>
            {% else %}
                <div class="other-message">
                    <strong>{{ message.sender.username }}<br></strong> <p class="other_message">{{ message.content }}</p> {{ message.timestamp|date:"H:i" }}
                </div>
            {% endif %}
        {% endfor %}
    </div>
    <div class="send_message">
        <input type="text" id="chat-message-input">
        <button id="chat-message-submit">전송</button>
    </div>
</div>
</body>
</html>
